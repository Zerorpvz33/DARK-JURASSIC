<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8 Assembler">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Jurassic | Live Tracker</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #e63946;
            --primary-glow: rgba(230, 57, 70, 0.4);
            --bg-dark: #050505;
            --card-bg: #0d0d0d;
            --border: #1a1a1a;
            --accent: #5dade2;
            --text-main: #eeeeee;
            --text-dim: #888888;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            opacity: 0; 
            transition: 0.5s; 
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-left: 4px solid var(--primary);
            padding-left: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        #map { 
            height: 500px; 
            border-radius: 12px; 
            border: 1px solid var(--border);
            z-index: 1;
        }

        .panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 5px; text-transform: uppercase; }
        input, select {
            width: 100%;
            background: #000;
            border: 1px solid #222;
            padding: 10px;
            color: white;
            border-radius: 5px;
            font-size: 0.9rem;
            outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn-report {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-report:hover { background: #ff4d5a; box-shadow: 0 0 15px var(--primary-glow); }

        .feed-container {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .sighting-item {
            padding: 15px;
            border-bottom: 1px solid #111;
            font-size: 0.85rem;
        }

        .status-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: inline-block;
        }
        .active-tag { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .expired-tag { background: rgba(255, 255, 255, 0.05); color: #555; }

        .map-hint {
            font-size: 0.7rem;
            color: var(--accent);
            margin-top: 5px;
            font-style: italic;
        }

        /* Leaflet Dark Theme Hack */
        .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-container { background: #000 !important; }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1 style="margin:0; font-size: 1.5rem; letter-spacing: 2px;">THREAT_TRACKER</h1>
                <p style="margin:0; color:var(--text-dim); font-size: 0.8rem;">Real-time InGen Asset Observation Map</p>
            </div>
            <a href="index.html" style="color:var(--text-dim); text-decoration:none;"><i class="fa fa-chevron-left"></i> Back</a>
        </div>

        <div class="main-grid">
            <div id="map"></div>

            <div class="panel">
                <h3 style="margin-top:0; color:var(--primary); font-size: 0.9rem; border-bottom: 1px solid #222; padding-bottom: 10px;">NEW ALERT</h3>
                <p class="map-hint"><i class="fa fa-mouse-pointer"></i> Click on the map to select the location.</p>

                <div class="input-group">
                    <label>Species Name</label>
                    <input type="text" id="dino-name" placeholder="e.g., Velociraptor">
                </div>
                <div class="input-group">
                    <label>Location (City/Region)</label>
                    <input type="text" id="dino-loc" placeholder="Click on the map or type here">
                </div>
                <div class="input-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Latitude</label>
                        <input type="text" id="dino-lat" readonly style="background: #080808; color: #666;">
                    </div>
                    <div>
                        <label>Longitude</label>
                        <input type="text" id="dino-lng" readonly style="background: #080808; color: #666;">
                    </div>
                </div>
                <div class="input-group">
                    <label>Image URL</label>
                    <input type="text" id="dino-img" placeholder="https://...">
                </div>

                <button class="btn-report" onclick="submitSighting()">Submit Report</button>

                <div class="feed-container" id="sighting-feed">
                    <!-- Feed items komen hier -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxYUTNlBuhPQ2neLPAYCLDg0e-J76DIuU",
            authDomain: "dark-jurassic-378b5.firebaseapp.com",
            databaseURL: "https://dark-jurassic-378b5-default-rtdb.firebaseio.com/",
            projectId: "dark-jurassic-378b5",
            storageBucket: "dark-jurassic-378b5.firebasestorage.app",
            messagingSenderId: "144100722100",
            appId: "1:144100722100:web:be3b4690724a7a117fdee1"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let map, markers = [];
        let currentAgent = "Unknown";
        let clickMarker = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentAgent = user.email.split('@')[0];
                document.body.style.opacity = "1";
                initMap();
                loadSightings();
            } else {
                window.location.href = "login.html";
            }
        });

        function initMap() {
            map = L.map('map').setView([52.1326, 5.2913], 7); // Start op Nederland

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            // KLIK EVENT OP KAART
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);

                // Update input velden
                document.getElementById('dino-lat').value = lat;
                document.getElementById('dino-lng').value = lng;

                // Plaats of verplaats tijdelijke marker
                if (clickMarker) {
                    clickMarker.setLatLng(e.latlng);
                } else {
                    clickMarker = L.marker(e.latlng, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: "<div style='background-color:var(--primary); width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px var(--primary);'></div>",
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    }).addTo(map);
                }

                // Reverse Geocoding (Stad opzoeken)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
                    .then(response => response.json())
                    .then(data => {
                        const city = data.address.city || data.address.town || data.address.village || data.address.suburb || "Onbekende Locatie";
                        const country = data.address.country || "";
                        document.getElementById('dino-loc').value = city + (country ? `, ${country}` : "");
                    })
                    .catch(err => {
                        console.error("Geocoding error:", err);
                        document.getElementById('dino-loc').value = "Locatie geselecteerd";
                    });
            });
        }

        function submitSighting() {
            const name = document.getElementById('dino-name').value;
            const loc = document.getElementById('dino-loc').value;
            const lat = document.getElementById('dino-lat').value;
            const lng = document.getElementById('dino-lng').value;
            const img = document.getElementById('dino-img').value || "https://via.placeholder.com/150/000000/FFFFFF?text=NO_IMAGE";

            if (!name || !loc || !lat || !lng) {
                alert("Vul alle gegevens in! Klik op de kaart voor coördinaten.");
                return;
            }

            db.ref('sightings').push().set({
                name: name,
                location: loc,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                image: img,
                reportedBy: currentAgent,
                timestamp: Date.now()
            }).then(() => {
                // Reset form
                document.getElementById('dino-name').value = "";
                document.getElementById('dino-loc').value = "";
                document.getElementById('dino-lat').value = "";
                document.getElementById('dino-lng').value = "";
                if (clickMarker) {
                    map.removeLayer(clickMarker);
                    clickMarker = null;
                }
                alert("Rapport succesvol verzonden!");
            });
        }

        function loadSightings() {
            const expirationTime = 3600000 * 24; // 24 uur geldig
            const list = document.getElementById('sighting-feed');

            db.ref('sightings').limitToLast(50).on('value', snap => {
                // Wis oude markers
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                list.innerHTML = "";

                const now = Date.now();
                
                // Omkeren voor nieuwste bovenaan
                let results = [];
                snap.forEach(child => { results.push(child.val()); });
                results.reverse().forEach(data => {
                    const active = (now - data.timestamp) < expirationTime;

                    // Feed Item
                    const item = document.createElement('div');
                    item.className = 'sighting-item';
                    item.innerHTML = `
                        <span class="status-tag ${active ? 'active-tag' : 'expired-tag'}">
                            ${active ? 'Actief' : 'Verlopen'}
                        </span><br>
                        <strong style="color:var(--primary)">${data.name}</strong><br>
                        <span style="font-size:0.7rem; color:var(--text-dim)">${data.location}</span><br>
                        <span style="font-size:0.6rem; color:#444;">AGENT_${data.reportedBy.toUpperCase()}</span>
                    `;
                    list.appendChild(item);

                    // Map Marker
                    if (active) {
                        const marker = L.marker([data.lat, data.lng]).addTo(map)
                            .bindPopup(`
                                <div style="text-align:center; color:white;">
                                    <strong style="color:var(--primary)">${data.name}</strong><br>
                                    <img src="${data.image}" style="width:120px; margin:5px 0; border:1px solid #333; border-radius:4px;"><br>
                                    <small>Gezien in ${data.location}</small>
                                </div>
                            `);
                        markers.push(marker);
                    }
                });
            });
        }
    </script>
</body>
</html>